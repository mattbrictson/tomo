<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Tomo::Testing::MockPluginTester - Tomo</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Tomo::Testing::MockPluginTester";
        var mkdocs_page_input_path = "api/testing/MockPluginTester.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script>
<script defer data-domain="tomo-deploy.com" src="https://plausible.io/js/script.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> Tomo
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../comparisons/">Comparisons</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../configuration/">Configuration</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Commands</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../commands/init/">init</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../commands/setup/">setup</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../commands/deploy/">deploy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../commands/run/">run</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../commands/tasks/">tasks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Plugins</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../plugins/core/">core</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../plugins/bundler/">bundler</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../plugins/env/">env</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../plugins/git/">git</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../plugins/nodenv/">nodenv</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../plugins/puma/">puma</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../plugins/rails/">rails</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../plugins/rbenv/">rbenv</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Tutorials</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../tutorials/deploying-rails-from-scratch/">Deploying Rails From Scratch</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../tutorials/writing-custom-tasks/">Writing Custom Tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../tutorials/publishing-a-plugin/">Publishing a Plugin</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../../Host/">Tomo::Host</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../Logger/">Tomo::Logger</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../Paths/">Tomo::Paths</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../PluginDSL/">Tomo::PluginDSL</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../Remote/">Tomo::Remote</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../Result/">Tomo::Result</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../TaskLibrary/">Tomo::TaskLibrary</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Tomo::Testing::MockPluginTester</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#class-methods">Class methods</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#newplugin_names-settings-release-new_tester">new(*plugin_names, settings: {}, release: {}) → new_tester</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#instance-methods">Instance methods</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#run_tasktask-args-nil">run_task(task, *args) → nil</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#call_helperhelper-args-kwargs-obj">call_helper(helper, *args, **kwargs) → obj</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mock_script_resultscript-stdout-stderr-exit_status-0-self">mock_script_result(script=/.*/, stdout: "", stderr: "", exit_status: 0) → self</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#executed_script-string">executed_script → String</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#executed_scripts-string">executed_scripts → [String]</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#stdout-string">stdout → String</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#stderr-string">stderr → String</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">Tomo</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>API &raquo;</li>
        
      
    
    <li>Tomo::Testing::MockPluginTester</li>
    <li class="wy-breadcrumbs-aside">
      
          <a href="https://github.com/mattbrictson/tomo/edit/main/docs/api/testing/MockPluginTester.md" class="icon icon-github"
          > Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="tomotestingmockplugintester">Tomo::Testing::MockPluginTester</h1>
<p>MockPluginTester is a helper object that allows tasks and helpers provided by plugins to be easily unit tested. It has no test framework dependencies so it can be used in Minitest, RSpec, or the testing framework of your choice.</p>
<p>MockPluginTester works by mocking the underlying SSH connection so that no actual remote SSH scripts are run. By default, the tester will simulate that the script runs successfully (exit status of 0) with empty stdout and stderr. You can then write assertions verifying that the script was run as expected. For example:</p>
<pre><code class="language-ruby">require &quot;tomo/testing&quot;

def test_setup_directories
  tester = Tomo::Testing::MockPluginTester.new(settings: { deploy_to: &quot;/app&quot; })
  tester.run_task(&quot;core:setup_directories&quot;)
  assert_equal(&quot;mkdir -p /app /app/releases /app/shared&quot;, tester.executed_script)
end
</code></pre>
<p>You can change the default mocking behavior by using <a href="#mock_script_resultscript42-stdout-stderr-exit_status-0-self">mock_script_result</a>, like this:</p>
<pre><code class="language-ruby">require &quot;tomo/testing&quot;

def test_install
  tester = Tomo::Testing::MockPluginTester.new(
    &quot;bundler&quot;, settings: { release_path: &quot;/app/release&quot; }
  )
  tester.mock_script_result(/bundle check/, exit_status: 1)
  tester.run_task(&quot;bundler:install&quot;)
  assert_equal(
    [
      &quot;cd /app/release &amp;&amp; bundle check&quot;,
      &quot;cd /app/release &amp;&amp; bundle install&quot;
    ],
    tester.executed_scripts
  )
end
</code></pre>
<p>Every MockPluginTester instance loads a fresh, independent tomo environment, so mocks, plugins, settings, etc. specified in one tester will not affect any other tests.</p>
<p>Note that you must <code>require "tomo/testing"</code> to use MockPluginTester.</p>
<h2 id="class-methods">Class methods</h2>
<h3 id="newplugin_names-settings-release-new_tester">new(*plugin_names, settings: {}, release: {}) → new_tester</h3>
<p>Build a new MockPluginTester that loads the given list of <code>plugin_names</code>. The resulting tester object can be used to simulate any tasks or helpers that are provided by these plugins. Note that the &ldquo;core&rdquo; plugin is always loaded implicitly and does not need to be specified.</p>
<p>Any <code>settings</code> that are specified will be applied <em>after</em> the defaults settings provided by the plugins have been defined. These settings can use template strings just like <a href="../../../configuration/#sethash">set</a>.</p>
<pre><code class="language-ruby">require &quot;tomo/testing&quot;

tester = Tomo::Testing::MockPluginTester.new(
  &quot;puma&quot;,
  settings: {
    application: &quot;test&quot;,
    current_path: &quot;/app/current&quot;
  }
)
</code></pre>
<p>Any <code>release</code> data specified will be available to the task under test via <code>remote.release</code>.</p>
<h2 id="instance-methods">Instance methods</h2>
<h3 id="run_tasktask-args-nil">run_task(task, *args) → nil</h3>
<p>Run the given <code>task</code> by its fully qualified name (the namespace is required). Any <code>args</code>, if specified, are passed to the task via <code>settings[:run_args]</code>.</p>
<p>Any remote SSH scripts run by the task (e.g. via <code>remote.run</code>) will be mocked according to rules previously supplied to <a href="#mock_script_resultscript42-stdout-stderr-exit_status-0-self">mock_script_result</a>. If a mock result has not been explicitly supplied, the script will use a default mock that returns a successful result with no output.</p>
<pre><code class="language-ruby">require &quot;tomo/testing&quot;

tester = Tomo::Testing::MockPluginTester.new(
  &quot;bundler&quot;, settings: { release_path: &quot;/app/release&quot; }
)
tester.mock_script_result(/bundle check/, exit_status: 1)
tester.run_task(&quot;bundler:install&quot;)
assert_equal(
  [
    &quot;cd /app/release &amp;&amp; bundle check&quot;,
    &quot;cd /app/release &amp;&amp; bundle install&quot;
  ],
  tester.executed_scripts
)
</code></pre>
<h3 id="call_helperhelper-args-kwargs-obj">call_helper(helper, *args, **kwargs) → obj</h3>
<p>Invoke the specified <code>helper</code> method name with the optional positional <code>args</code> and keyword <code>kwargs</code>. Returns the return value of the helper. Remote SSH scripts are mocked as explained in <a href="#run_tasktask-42args-nil">run_task</a>.</p>
<pre><code class="language-ruby">require &quot;tomo/testing&quot;

def test_capture_returns_stdout_not_stderr
  tester = Tomo::Testing::MockPluginTester.new
  tester.mock_script_result(stderr: &quot;oh no&quot;, stdout: &quot;hello world\n&quot;)
  captured = tester.call_helper(:capture, &quot;greet&quot;)
  assert_equal(&quot;hello world\n&quot;, captured)
end
</code></pre>
<h3 id="mock_script_resultscript-stdout-stderr-exit_status-0-self">mock_script_result(script=/.*/, stdout: &ldquo;&rdquo;, stderr: &ldquo;&rdquo;, exit_status: 0) → self</h3>
<p>Mock the return value of remote SSH scripts that match the given <code>script</code>. If <code>script</code> is a String, the mock rule will apply only to scripts that match this String exactly. If <code>script</code> is Regexp, the mock rule will apply to any scripts that match that pattern. If <code>script</code> is omitted, the mock rule will apply always.</p>
<p>In this example, any task or helper invoked via this tester that runs <code>readline /app/current</code> will receive the given mock stdout response:</p>
<pre><code class="language-ruby">tester.mock_script_result(&quot;readlink /app/current&quot;, stdout: &lt;&lt;~OUT)
  /app/releases/20190420203028
OUT
</code></pre>
<p>Here, any script that includes <code>systemctl</code> will fail with an exit status of 1:</p>
<pre><code class="language-ruby">tester.mock_script_result(/systemctl/, exit_status: 1)
</code></pre>
<p>This mocks <em>all</em> scripts to fail with exit status of 255 and stderr of &ldquo;oh no!&rdquo;:</p>
<pre><code class="language-ruby">tester.mock_script_result(exit_status: 255, stderr: &quot;oh no!&quot;)
</code></pre>
<h3 id="executed_script-string">executed_script → String</h3>
<p>The remote SSH script that was run by a previous invocation of <a href="#run_tasktask-42args-nil">run_task</a> or <a href="#call_helperhelper-42args-4242kwargs-obj">call_helper</a>. If no script was run, then <code>nil</code> is returned. If more that one script was run, this will raise a <code>RuntimeError</code>.</p>
<h3 id="executed_scripts-string">executed_scripts → [String]</h3>
<p>All remote SSH scripts that were run by a previous invocation of <a href="#run_tasktask-42args-nil">run_task</a> or <a href="#call_helperhelper-42args-4242kwargs-obj">call_helper</a>. If no script was run, then an empty array is returned.</p>
<h3 id="stdout-string">stdout → String</h3>
<p>Everything that was written to stdout during the most recent invocation of <a href="#run_tasktask-42args-nil">run_task</a> or <a href="#call_helperhelper-42args-4242kwargs-obj">call_helper</a>. If nothing was written, then the empty string is returned.</p>
<h3 id="stderr-string">stderr → String</h3>
<p>Everything that was written to stderr during the most recent invocation of <a href="#run_tasktask-42args-nil">run_task</a> or <a href="#call_helperhelper-42args-4242kwargs-obj">call_helper</a>. If nothing was written, then the empty string is returned.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../TaskLibrary/" class="btn btn-neutral float-left" title="Tomo::TaskLibrary"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/mattbrictson/tomo/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../../TaskLibrary/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme_extra.js" defer></script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../js/extra.js" defer></script>
      <script src="../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
